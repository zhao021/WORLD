# 世界留痕—何处所想

World-s-Imprint-Whither-the-Thought

一个互动式地图应用，允许用户在地图上标记并分享情绪和想法。

## 使用方法

### 启动Web服务器

使用以下任一方法启动本地Web服务器：

#### 方法1：使用PHP内置服务器（推荐）

点击start-server-ansi.bat文件即可

#### 方法2：使用PHP内置服务器（推荐）

```bash
# 进入项目目录
cd 项目目录

# 启动PHP内置服务器
php -S localhost:8000
```

然后在浏览器中访问 `http://localhost:8000`

这种方法可以同时支持PHP脚本，实现无弹窗自动保存功能。

#### 方法3：使用Python

```bash
# Python 3.x
python -m http.server

# Python 2.x
python -m SimpleHTTPServer
```

然后在浏览器中访问 `http://localhost:8000`

#### 方法4：使用Node.js

```bash
npm install -g http-server
http-server -p 8000
```

然后在浏览器中访问 `http://localhost:8000`

#### 方法5：使用VS Code Live Server扩展

1. 在VS Code中安装"Live Server"扩展
2. 右键点击`index.html`文件
3. 选择"Open with Live Server"



## 功能介绍

- **添加标记**：点击地图任意位置，填写信息后添加新标记
- **查看标记**：点击地图上的标记查看详细信息
- **自动定位**：自动识别点击位置的城市名称
- **本地存储**：所有数据保存到本地文件
- **数据管理**：通过文件管理页面导入/导出数据

## 技术说明

### 本地存储架构

本应用使用本地文件作为主要数据存储，主要优点：

1. **离线可用**：无需网络连接即可使用
2. **即时保存**：数据实时保存到本地文件中
3. **历史记录**：每次添加标记都会自动创建历史记录文件
4. **备份功能**：支持手动备份数据

### 数据存储逻辑

#### 存储目录结构

应用使用三个不同的目录来存储数据：

1. **当前数据目录** (`output/current/`):
   - 包含单个文件 `markers_data.json`
   - 存储当前应用的所有标记数据
   - 每次添加新标记时自动更新

2. **历史记录目录** (`output/history/`):
   - 每次添加新标记时自动创建一个新文件
   - 文件命名格式：`emotion_map_YYYYMMDD_HHMMSS.json`
   - 用于追踪数据变更历史

3. **备份目录** (`output/backups/`):
   - 用于手动备份数据
   - 通过点击"导出备份"按钮创建
   - 文件命名格式：`emotion_map_YYYYMMDD_HHMMSS.json`

#### 数据流程

1. **初始化**：应用启动时，从当前数据文件加载数据
2. **加载数据**：从 `output/current/markers_data.json` 读取
3. **添加标记**：
   - 用户在地图上点击位置
   - 填写标记信息
   - 数据同时保存到当前数据文件和历史记录目录
   - 在地图上显示新标记
4. **备份数据**：点击导出按钮将数据保存到备份目录

#### 文件管理功能

通过文件管理页面(`file-manager.html`)可以：

- **查看数据**：显示当前存储的所有标记
- **导出数据**：将数据导出为JSON文件，保存到备份目录
- **导入数据**：从JSON文件导入数据，同时更新当前数据和创建历史记录
- **清空数据**：删除所有标记数据

### 城市定位方式

本应用使用以下方法确定城市名称：

1. **Nominatim API**：
   - 基于OpenStreetMap提供的免费地理编码服务
   - 无需注册API密钥
   - 支持全球范围的地理位置查询
   - 请求格式：`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`

2. **备用方案**：
   - 当API请求失败时，使用预设的中国主要城市坐标数据
   - 基于经纬度计算最近的城市
   - 如果距离在城市半径范围内，返回该城市名称
   - 否则返回"[城市名]附近"

## 配置说明

如果需要修改配置，可以编辑以下文件：

- `js/map.js`: 修改数据库配置、地图设置等
- `css/style.css`: 修改样式

### 数据存储配置

数据存储配置位于`js/map.js`文件的开头：

```javascript
// 文件存储配置
const STORAGE_CONFIG = {
  currentFile: 'output/current/markers_data.json', // 当前数据文件
  backupsDir: 'output/backups/', // 手动备份目录
  historyDir: 'output/history/', // 历史记录目录
  version: 1
};
```

### 数据导出/导入

数据导出/导入通过文件管理页面进行：

1. 点击页面右上角的"文件管理"按钮
2. 在文件管理页面中：
   - 点击"导出数据"将数据保存为JSON文件，自动存储到备份目录
   - 点击"导入数据"从JSON文件加载数据，同时更新当前数据和创建历史记录

### 首次使用注意事项

1. 首次使用前，请确保已创建以下目录结构：
   ```
   output/
   ├── backups/  # 手动备份目录
   ├── current/  # 当前数据文件目录
   └── history/  # 历史记录目录
   ```

2. 地区自动获取功能设置了3秒超时，如果超时将允许用户手动输入城市名称

3. 每次添加标记时，数据会自动保存到本地文件，并创建历史记录

4. 如果需要手动备份数据，请使用导出功能将数据保存到备份目录

### 数据保存机制

应用使用多重保存机制确保数据安全：

1. **主要保存方式**：通过PHP脚本保存到服务器文件系统
   - 保存在 `output/current/markers_data.json`（当前数据）
   - 保存在 `output/history/` 目录（历史记录）
   - 保存在 `output/backups/` 目录（手动备份）

2. **备用保存方式**：当PHP保存失败时，自动回退到以下方式
   - **本地存储**：保存到浏览器的localStorage
   - **文件下载**：如果localStorage也失败，则触发文件下载

3. **数据恢复机制**：
   - 优先从服务器文件加载数据
   - 如果服务器文件不可用，尝试从localStorage加载
   - 加载成功后，自动将数据同步到所有存储位置

### 使用注意事项

1. **推荐使用PHP环境**：
   - 使用PHP内置服务器可获得最佳体验
   - 如果没有PHP环境，系统会自动使用备用存储方式

2. **数据同步**：
   - 当从备用存储加载数据时，系统会尝试将数据同步到文件系统
   - 手动导入数据时，会同时更新文件系统和本地存储

3. **数据备份**：
   - 定期使用"导出备份"功能备份数据
   - 备份文件保存在 `output/backups/` 目录

## 数据结构

每个标记的数据结构如下：

```javascript
{
  title: "标记标题",
  content: "标记内容",
  date: "2023-05-15",  // 日期
  city: "北京",        // 城市名称
  longitude: 116.4074, // 经度
  latitude: 39.9042,   // 纬度
  type: "心愿碟",      // 标记类型
  likes: 0,           // 点赞数
  timestamp: 1684123456789, // 时间戳（作为主键）
  create_date: "2023-05-15T08:30:45.123Z" // 创建时间
}
```

## 联系作者

灵感来源于melbourne-map-demo，后魔改为以上功能与内容。

目的是参考打卡地图和在某些地方会有独特的记忆的一个简单记录。

数据与内容，均为本地保存，后期可能会实现云端数据库保存，本来想在EMAS Serverless 中实现，但是还是有一些小问题，因此暂时放弃。（技术暂时属于菜鸡，多谢chatgpt），大佬们也可以改进一下。
联系方式：zoemarsh937@gmail.com